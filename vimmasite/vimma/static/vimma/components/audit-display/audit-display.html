<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-elements/core-elements.html">
<link rel="import" href="../bower_components/paper-elements/paper-elements.html">

<link rel="import" href="../error-display/error-display.html">
<link rel="import" href="../local-date/local-date.html">

<polymer-element name="audit-display" attributes="vmid userid"
  on-ajax-start="{{onAjaxStart}}" on-ajax-end="{{onAjaxEnd}}">
  <template>
    <link rel="stylesheet" type="text/css" href="audit-display.css">

    <button on-click="{{reload}}"disabled?="{{ajaxInProgress}}">
      Refresh logs
    </button>
    <br>

    <template if="{{!apiResult}}">
      Loading…
    </template>
    <template if="{{apiResult}}">
      <template bind ref="main"></template>
    </template>

    <template if="{{!ajaxInProgress && !ajaxSuccess}}">
      <br>
      <error-display text={{ajaxErrTxt}}></error-display>
    </template>

    <template id="main">
      <div id="box">
        <template bind ref="navigation"></template>
        <template bind ref="table"></template>
      </div>
    </template>

    <template id="navigation">
      <div id="navigation">
        <button type="button" on-click="{{loadPrevious}}"
          disabled?="{{ajaxInProgress || !apiResult.previous}}">
          ← prev
        </button>
        <span id="item-range">
          <!-- show 0–0 for no items -->
          Showing items {{firstItemNr}}–{{getLastItemNr()}}
          of {{apiResult.count}}
        </span>
        <button type="button" on-click="{{loadNext}}"
          disabled?="{{ajaxInProgress || !apiResult.next}}">
          next →
        </button>
      </div>
    </template>

    <template id="table">
      <table>
        <!--
          Using a named template so its content can access getUserText(…).
          This wouldn't be possible using an unnamed template.
        -->
        <template repeat="{{apiResult.results as r}}">
          <tr>
            <td><local-date date="{{r.timestamp}}"></local-date></td>
            <td>{{r.level}}</td>
            <td>{{r.vm || '—'}}</td>
            <td>{{getUserText(r.user)}}</td>
            <td><plain-text text="{{r.text}}"></plain-text></td>
          </tr>
        </template>
      </table>

      <button id="show-more" type="button" on-click="{{showMore}}"
        disabled?="{{ajaxInProgress || pageSize >= maxPageSize}}">
          Show more
      </button>
    </template>
  </template>

  <script src="audit-display.js"></script>
</polymer-element>
