<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-elements/core-elements.html">
<link rel="import" href="../bower_components/paper-elements/paper-elements.html">

<link rel="import" href="dummy-vm-detail.html">
<link rel="import" href="dummy-vm-summary.html">
<link rel="import" href="aws-vm-detail.html">
<link rel="import" href="aws-vm-summary.html">
<link rel="import" href="vm-schedule-picker.html">
<link rel="import" href="../vm-recent-errors/vm-recent-errors.html">
<link rel="import" href="../local-date/local-date.html">
<link rel="import" href="../user-display/user-display.html">
<link rel="import" href="../error-display/error-display.html">
<link rel="import" href="../ajax-state/ajax-state.html">

<polymer-element name="vm-detail" attributes="vmid initiallyExpanded">
  <template>
    <link rel="stylesheet" type="text/css" href="/static/vimma/components/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="vm-detail.css">

    <ajax-state id="ajax"></ajax-state>

    <template if="{{loading}}">
      Loading…
    </template>

    <template if="{{!loading}}">
      <template if="{{loadingSucceeded}}">
        <template bind ref="vm"></template>
      </template>
    </template>

    <template if="{{!$.ajax.inProgress && !$.ajax.success}}">
      <div>
        <error-display text={{$.ajax.errorText}}></error-display>
      </div>
    </template>

    <template id="vm">
      <template bind ref="vm-summary"></template>
      <template if="{{expanded}}">
        <template bind ref="vm-expanded"></template>
      </template>
    </template>

    <template id="vm-summary">
      <div id="summary">
        <paper-button id="expand" on-click="{{toggleExpanded}}" raised
          title="{{expanded ? 'Collapse' : 'Expand'}}">
          <core-icon icon="{{expanded ? 'expand-less' : 'expand-more'}}">
          </core-icon>
        </paper-button>

        <paper-button id="reload" on-click="{{reload}}" raised
          title="Refresh" disabled?="{{$.ajax.inProgress}}">
          <core-icon icon="cached"></core-icon>
        </paper-button>

        <template if="{{vm.destroyed_at}}">
          <span title="Destroyed"
            class="destroyed-logo glyphicon glyphicon-warning-sign"></span>
        </template>

        <div id="prov-summ">
          <template bind ref="provider-specific-summary"></template>
          <template bind ref="vm-comment"></template>
          <template bind ref="recent-errors"></template>
        </div>

        <span id="project-name">{{project.name}}</span>

        <paper-button id="reboot" on-click="{{reboot}}" raised
          title="Reboot" disabled?="{{$.ajax.inProgress}}">
          <core-icon icon="redo"></core-icon>
        </paper-button>
        <paper-button id="destroy" on-click="{{destroy}}" raised
          title="Destroy" disabled?="{{$.ajax.inProgress}}">
          <core-icon icon="delete"></core-icon>
        </paper-button>
      </div>
    </template>

    <template id="provider-specific-summary">
      <template if="{{provider.type == 'dummy'}}">
        <dummy-vm-summary vmid="{{vmid}}"></dummy-vm-summary>
      </template>

      <template if="{{provider.type == 'aws'}}">
        <aws-vm-summary vmid="{{vmid}}"></aws-vm-summary>
      </template>

      <template if="{{provider.type != 'dummy' && provider.type != 'aws'}}">
        <error-display
          text="{{'Unknown vm provider type: “' + provider.type + '”'}}">
        </error-display>
      </template>
    </template>

    <template id="vm-comment">
      <template if="{{vm.comment}}">
        <div>Comment: {{vm.comment}}</div>
      </template>
    </template>

    <template id="recent-errors">
      <div>
        <vm-recent-errors vmid="{{vmid}}"></vm-recent-errors>
      </div>
    </template>
    <template id="recent-errors-verbose">
      <div>
        <vm-recent-errors vmid="{{vmid}}" showabsence="{{true}}">
        </vm-recent-errors>
      </div>
    </template>

    <template id="vm-expanded">
      <template if="{{vm.destroy_request_at || vm.destroyed_at}}">
        <div id="destroyed-details">
          Destruction requested on
          <local-date date="{{vm.destroy_request_at}}"
            alwaysshowdate hidemillis>
          </local-date>
          by <user-display userid="{{vm.destroy_request_by}}"></user-display>.
          <br>

          <template if="{{!vm.destroyed_at}}">
            Destruction has not succeeded yet.
          </template>
          <template if="{{vm.destroyed_at}}">
            Destruction completed on
            <local-date date="{{vm.destroyed_at}}" alwaysshowdate hidemillis>
            </local-date>.
          </template>
        </div>
      </template>

      <template if="{{provider.type == 'dummy'}}">
        <dummy-vm-detail vmid="{{vmid}}">
        </dummy-vm-detail>
      </template>

      <template if="{{provider.type == 'aws'}}">
        <aws-vm-detail vmid="{{vmid}}"></aws-vm-detail>
      </template>

      <template if="{{provider.type != 'dummy' && provider.type != 'aws'}}">
        <error-display
          text="{{'Unknown vm provider type: “' + provider.type + '”'}}">
        </error-display>
      </template>

      <div>
        Created by <user-display userid="{{vm.created_by}}"></user-display> on
        <local-date date="{{vm.created_at}}" hidemillis="{{true}}">
        </local-date>
      </div>
      <template bind ref="vm-comment"></template>
      <div>
        <vm-schedule-picker vmid="{{vmid}}"></vm-schedule-picker>
      </div>
      <template bind ref="schedule-override"></template>
      <template bind ref="recent-errors-verbose"></template>
      <template bind ref="audit"></template>
    </template>

    <template id="schedule-override">
      <div id="schedule-override">
        <template if="{{vm.sched_override_state == null}}">
          No override in effect.
        </template>
        <template if="{{vm.sched_override_state != null}}">
          Overridden to Powered
          {{vm.sched_override_state == true ? 'ON' : 'OFF'}}
          until {{tstampToString(vm.sched_override_tstamp)}}.
          <button on-click="{{overrideClear}}">Clear override</button>
        </template>
        <br>
        <label>Keep</label>
        <paper-dropdown-menu disabled?="{{$.ajax.inProgress}}">
          <paper-dropdown class="dropdown">
            <core-menu class="menu" selected="{{overrideSchedStateIdx}}">
              <template repeat="{{s in overrideSchedStates}}">
                <paper-item>{{s.label}}</paper-item>
              </template>
            </core-menu>
          </paper-dropdown>
        </paper-dropdown-menu>
        <label>for</label>
        <input type="number" value="{{overrideSchedMins}}"
          disabled?="{{$.ajax.inProgress}}"> min
        <button on-click="{{overrideSet}}" disabled?="{{$.ajax.inProgress}}">
          Set override
        </button>
      </div>
    </template>

    <template id="audit">
      <div id="audit">
        <strong id="toggle-logs" on-click="{{toggleShowLogs}}"
            title="{{showLogs ? 'Hide logs' : 'Show logs'}}">
          <template if="{{!showLogs}}">▹ Logs</template>
          <template if="{{showLogs}}">▾ Logs</template>
        </strong>
        <template if="{{showLogs}}">
          <div id="audit-display">
            <audit-display vmid="{{vmid}}"></audit-display>
          </div>
        </template>
      </div>
    </template>
  </template>

  <script src="vm-detail.js"></script>
</polymer-element>
