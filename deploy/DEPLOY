This file has 2 sections:
1. How to re-deploy to an already configured server
2. How to install on a new server


1. How to re-deploy to an already configured server
===================================================
cd deploy
rm -rf env
virtualenv env
. env/bin/activate
pip install -r req.txt
fab [-u «your-ssh-username»] [-H «server.name»] deploy
deactivate


2. How to install on a new server
=================================
Ubuntu 14.04
sudo adduser --disabled-password vimma2
sudo apt-get --yes install \
        build-essential vim htop \
        apache2 libapache2-mod-auth-pubtkt libapache2-mod-wsgi-py3 \
        rabbitmq-server python3 python3-pip python-virtualenv \
        supervisor postgresql libpq-dev python-dev \
        npm git \
        xvfb chromium-browser chromium-chromedriver firefox
sudo ln -s /usr/bin/nodejs /usr/bin/node
sudo npm install -g bower


put the SSL certificate in:
/home/vimma2/server.crt
/home/vimma2/server.key

sudo su vimma2
echo >/home/vimma2/tkt_pubkey.pem \
"-----BEGIN PUBLIC KEY-----
MIIBuDCCASwGByqGSM44BAEwggEfAoGBAJ8b2D4GV1cHrNUgx4nx8lOAZWqpcfQO
jjx0iPnPlpEKCqnHWflS2jeN1BOOY9ovcUMNoZNS7kSXBFiG0jkKwPEhf9Vj4Q0Y
vhYDTg3QbTgDvHMi6z8rTojatysyUTX/LN0y4554trU9/Z6z3kG0TVfQtaN/8meb
ZEGfG+aj+NjbAhUAuLjC0Jx0k+VyrA/Cq29CJ9HdYecCgYEAhbdTlxChl1hmKzra
HsPyI2LBTBY9GxpprGJS+uoCk+B4+xkNHTgyO5L9u7m9s8snbNZGPkje+nMOof7E
pyHsqI9ghzIkKHVP5KjtTjn9e/lk8VKY8+v8k0OlgzUyxdrUEC5Xnd/WgaMev+bA
xnU7DCL4sPOA5yu3e8P69NyAzSIDgYUAAoGBAJSxUNG74DW4DlXwBPO4v+9GFyXT
+b0cRkln8k6AwtBB4NRTVFXWsqIk8xXcUTBpQ7eBd6KoKzoMktHJ0N+a0TRK5L4o
/DiC0K6BUcuYGHUz6CUikQep9Mx8aQMrcK6wEFNh0jWqfPW7e9B+kXLVJ+ozF/XN
bC6xzSqdfX0hVeKr
-----END PUBLIC KEY-----"
exit

sudo service apache2 stop
sudo a2enmod ssl

sudo su
echo >>/etc/apache2/sites-enabled/000-default.conf \
'<VirtualHost *:443>
        SSLEngine       on
        SSLCertificateFile      /home/vimma2/server.crt
        SSLCertificateKeyFile   /home/vimma2/server.key

        DocumentRoot /var/www/html

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        <Location />
                AuthType                mod_auth_pubtkt
                TKTAuthPublicKey        /home/vimma2/tkt_pubkey.pem

                TKTAuthLoginURL         https://login.futurice.com/
                TKTAuthTimeoutURL       https://login.futurice.com/?timeout=1
                TKTAuthUnauthURL        https://login.futurice.com/?unauth=1
                TKTAuthToken            "futu"

                Require valid-user
        </Location>

        Alias /static/ /home/vimma2/vimma2/vimmasite/static/
        <Directory /home/vimma2/vimma2/vimmasite/static/>
        </Directory>

        WSGIScriptAlias /       /home/vimma2/vimma2/vimmasite/vimmasite/wsgi.py
        WSGIDaemonProcess       vimmasite user=vimma2 group=vimma2 python-path=/home/vimma2/vimma2/vimmasite:/home/vimma2/config:/home/vimma2/env/lib/python3.4/site-packages
        WSGIProcessGroup        vimmasite
</VirtualHost>'
exit


sudo -u postgres createuser vimma2
sudo -u postgres psql -c 'alter user vimma2 with createdb' postgres
sudo service postgresql stop

in /etc/postgresql/9.*/main/pg_hba.conf replace ‘md5’ with ‘trust’ on the line:
host    all             all             127.0.0.1/32            md5

sudo service postgresql start
sudo -u vimma2 createdb vimma


sudo service supervisor stop

sudo su
echo -n >/etc/supervisor/conf.d/celery-worker.conf \
'[program:celery-worker]
command=/home/vimma2/vimma2/deploy/celery-worker.sh
startsecs=0
user=vimma2
directory=/home/vimma2/
autostart=true
autorestart=true
stdout_logfile=/home/vimma2/celery-worker-stdout
stderr_logfile=/home/vimma2/celery-worker-stderr
'

echo -n >/etc/supervisor/conf.d/celery-beat.conf \
'[program:celery-beat]
command=/home/vimma2/vimma2/deploy/celery-beat.sh
startsecs=0
user=vimma2
directory=/home/vimma2/
autostart=true
autorestart=true
stdout_logfile=/home/vimma2/celery-beat-stdout
stderr_logfile=/home/vimma2/celery-beat-stderr
'
exit


sudo su vimma2
rm -rf /tmp/repo-tmp
git clone https://github.com/futurice/vimma2.git /tmp/repo-tmp
mkdir /home/vimma2/config
cp /tmp/repo-tmp/config/local_settings.py.example /home/vimma2/config/local_settings.py
cp /tmp/repo-tmp/config/secrets.py.example /home/vimma2/config/secrets.py
rm -rf /tmp/repo-tmp
exit

Configure the SECRET_KEY and DB in /home/vimma2/config/local_settings.py
Set the FUM_API_TOKEN in /home/vimma2/config/secrets.py


sudo su vimma2
EDITOR=vim crontab -e

Add this entry to crontab:
7-59/30 * * * *	PATH=/home/vimma2/env/bin:$PATH PYTHONPATH=/home/vimma2/config /home/vimma2/vimma2/scripts/import-futurice-users.py >>~/import-futu-users-out 2>>~/import-futu-users-err

exit


Now go to step 1. above, at the start of this file.
